<?php$client_fields = get_option('nhb_client_fields');if(!empty($_POST)) {	$json = array();			$nhb_basket = nhb_get_basket();			if(empty($nhb_basket['products'])) {		$json['errors'][] = __('Пустой заказ не может быть обработан', 'nhb');	}			$client_data = array_map('htmlspecialchars', $_POST['nhb_client']);	$client_data = array_map('trim', $client_data);			$_SESSION['nhb_client_data'] = $client_data;	foreach($client_data as $client_field_name => $client_field_value) {		if(!isset($client_fields[$client_field_name])) {			$json['errors'][] = __('Неизвестное поле: ', 'nhb').htmlspecialchars($client_field_name);		}		elseif($client_fields[$client_field_name]['require']) {			if(trim($client_field_value) == '') {				$json['errors'][] = __('Не заполнено обязательное поле: ', 'nhb').htmlspecialchars($client_field_name);			}		}	}	$products = array();			foreach($nhb_basket['products'] as $item_id => $product) {		if($product = get_post($product['id'])) {			$products[] = $product;		}	}			if(empty($products)) $json['errors'][] = __('Неизвестная ошибка', 'nhb').' - 001';	if(get_option('nhb_min_sum') && get_option('nhb_min_sum') > $nhb_basket['price']) {		$json['errors'][] = __('Сумма заказа не превышает минимальную', 'nhb').' ('.get_option('nhb_min_sum').' '.get_option('nhb_currency').')';	}			if(empty($json['errors'])) {		$template_directory = get_template_directory();		ob_end_clean();		ob_start();		if(file_exists($template_directory.'/nethammer_basket/order_letter.php')) {			require $template_directory.'/nethammer_basket/order_letter.php';		}		else {			require NHB_DIR.'/views/order_letter.php';		}		$letter_body = ob_get_contents();		ob_end_clean();		$letter = '<html><body>'.$letter_body.'</body></html>';		if(!$manager_email = get_option('nhb_orders_email')) {			$manager_email = get_bloginfo('admin_email');		}		$headers .= 'Content-type: text/html; charset=utf-8' . "\r\n";		$order_post = array(			'post_type' => NHB_TYPE_ORDERS,			'post_title'    => $client_data[NHB_ORDER_PRIMARY_FIELD].' - '.$client_data[NHB_REVIEW_PHONE_FIELD_NAME],			'post_content'  => $letter_body,			'post_status'   => 'draft',			'post_author'   => NHB_AUTHOR		);		$order_id = wp_insert_post($order_post);		$json['order_id'] = $order_id;					wp_mail($manager_email, "$_SERVER[HTTP_HOST] :: ".__('Заказ', 'nhb').' '.$order_id, $letter, $headers);		nhb_clear_basket();		$json['done'] = __('Спасибо за заказ в нашем магазине!', 'nhb');	}	echo json_encode($json);	die();}?>